# Table of Contents

1. [Setup](#setup)
1. [Quickstart](#quickstart)
1. [Provided Dataset and Config](#provided-dataset-and-config)
1. [Synthetic Data Generation](#synthetic-data-generation)
   1. [Synthetic Data Generator](#synthetic-data-generator)
   1. [Modules](#modules)
   1. [Configuration](#configuration)
   1. [Process Data](#process-data)
   1. [Knowledge Graph](#knowledge-graph)
1. [Link Prediction Bias Analysis](#link-prediction-bias-analysis)

## Setup

1. Clone the repository with `git clone https://github.com/0x14d/PDPK.git`
1. Open repository with `cd PDPK`
1. <b>Python 3.9</b> is required (2 options)
   - Use the included dev container (requires <b>Docker</b>)
   - Install python manually
1. Create virtual environment (optional)
   1. `python -m venv ./venv`
   1. `source ./venv/bin/activate`
1. Install requirements with `pip install -r requirements.txt`

## Quickstart

The `notebooks/quickstart.ipynb` jupyter notebook provides a simple introduction into the usage of the synthetic data generator.

## Provided Dataset and Config

This repo contains an example configuration for the synthetic data generator. It is located in `configs/default_config_sdg.json`.

This configuration was used to generate process data, a knowledge graph and the metadata of the dataset. All these files are located in `dataset`.

## Synthetic Data Generation

### Synthetic Data Generator

The class `SyntheticDataGenerator` located in `data_provider/synthetic_data_generation/synthetic_data_generator.py` is the key component of the synthetic data generation. It provides functionality to generate process data and knowledge graphs.
In order to generate data a configuration for the generator is needed (see [Configuration](#configuration)).

##### Constructor

`SyntheticDataGenerator(config: SdgConfig|str|dict)`

| Argument | Type                                             | Description                                                                                                                                                                                                                                                                                                    |
| -------- | ------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `config` | [`SdgConfig`](#configuration) or `str` or `dict` | Configuration of the synthetic data generator <ul><li>[`SdgConfig`](#configuration): config in form of a [`SdgConfig`](#configuration) object</li><li>`str`: Path to a config json file</li><li>`dict`: config in form of a `dict` with the same structure as a [`SdgConfig`](#configuration) object</li></ul> |

##### Properties

| Property          | Type                                                                                             | Description                                                                                 |
| ----------------- | ------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------- |
| `dataset`         | [`GeneratedDataset`](#process-data)                                                              | Process data generated by the synthetic data generator                                      |
| `knowledge_graph` | [`igraph.Graph`](https://igraph.readthedocs.io/en/stable/api/igraph.Graph.html)                  | Knowledge graph generated by the synthetic data generator                                   |
| `metadata`        | [`rdflib.Graph`](https://rdflib.readthedocs.io/en/stable/apidocs/rdflib.html#rdflib.graph.Graph) | Metadata of the dataset in form of a rdf graph                                              |
| `uuid`            | `str`                                                                                            | UUID of the dataset. Changes whenever a new process data or a knowledge graph is generated. |

##### Methods

| `def create_new_dataset(self) -> GeneratedDataset`                                      |
| --------------------------------------------------------------------------------------- |
| Creates new process data. The property `dataset` now contains the newly generated data. |
| Returns [`GeneratedDataset`](#process-data): Generated process data                     |

| `def create_new_knowledge_graph(self) -> igraph.Graph`                                                             |
| ------------------------------------------------------------------------------------------------------------------ |
| Creates a new knowledge graph. The property `knowledge_graph` now contains the newly generated knowledge graph.    |
| Returns [`igraph.Graph`](https://igraph.readthedocs.io/en/stable/api/igraph.Graph.html): Generated knowledge graph |

| `def get_knowledge_graph_as_rdf(self, use_literals: bool=False) -> rdflib.Graph`                                                        |
| --------------------------------------------------------------------------------------------------------------------------------------- |
| Converts the knowledge graph to rdf format.                                                                                             |
| Parameters: <br> <ul><li>`use_literals (bool)`: Should the literals be included in the rdf graph? (Default: `False`)</li></ul>          |
| Returns [`rdflib.Graph`](https://rdflib.readthedocs.io/en/stable/apidocs/rdflib.html#rdflib.graph.Graph): Knowledge graph in rdf format |

### Modules

The synthetic data generation in seperated in different modules. Each module responsible for a specific part of the data generation. The code of all the modules is located in `data_provider/synthetic_data_generation/modules` and `data_provider/knowledge_graphs/generators`.

| Module                      | Description                                                                                                                                                               |
| --------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| PQ-Tuple Generator          | Generates what process parameters and quality features are correlating. Also generates which of these correlations are known by the simulated experts (expert knowledge). |
| PQ-Function                 | Function that describes how the correlating parameters influence their associated quality features                                                                        |
| PQ-Function Generator       | Generates the underlying pq-functions.                                                                                                                                    |
| Experiment Series Generator | Generates simulated parametrization processes.                                                                                                                            |
| Experiment Generator        | Use the Experiment Series Generator(s) to generate parametrization processes and merges them together to a single dataset.                                                |
| Noise Generator             | Adds optional noise to the final generated dataset.                                                                                                                       |
| Knowledge Graph Generator   | Generates the knowledge graph that represents the expert knowledge.                                                                                                       |

#### PQ-Tuple Generator

| Generator               | Description                                                                                                             |
| ----------------------- | ----------------------------------------------------------------------------------------------------------------------- |
| `BasicPQTupleGenerator` | Randomly chooses pq-tuples that represent parameter-quality-correlations and pq-tuples that represent expert knwoledge. |

#### PQ-Function

| Generator               | Description                                                              |
| ----------------------- | ------------------------------------------------------------------------ |
| `LinearPQFunction`      | Function of shape `f(x) = a + bx`                                        |
| `QuadraticPQFunction`   | Function of shape <code>f(x) = a + bx + cx<sup>2</sup></code>            |
| `LogarithmicPQFunction` | Function of shape <code>f(x) = a<i>log</i><sub>b</sub>(x - c) + d</code> |

#### PQ-Function Generator

| Generator                             | Description                                          |
| ------------------------------------- | ---------------------------------------------------- |
| `SingleComplexityPQFunctionGenerator` | All generated pq-functions have the same complexity. |

#### Experiment Series Generator

| Generator                                  | Description                                                                                                                                                                                                                                                                                                                                            |
| ------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `ExpertKnowledgeExperimentSeriesGenerator` | Each parametrization process optimizes a set of quality features by using the expert knowledge. It starts with a randomly initialized experiment and in each step all process parameters that are known to influence the quality features are optimized until all quality features reach a certain threshold.                                          |
| `TrialExperimentSeriesGenerator`           | Each experiment series optimizes a set of qualities by trying out different parameter adjustments. It starts with a random initialized experiment and in each step some parameters are adjusted in order to change the resulting qualities. If the qualities get better the same parameters are further adjusted. Otherwise new parameters are tested. |

#### Experiment Generator

| Generator                       | Description                                                                |
| ------------------------------- | -------------------------------------------------------------------------- |
| `SingleTypeExperimentGenerator` | Generates a dataset by using a single type of experiment series generator  |
| `MultiTypeExperimentGenerator`  | Generates a dataset by using multiple types of experiment series generator |

#### Noise Generator

| Generator                | Description                                 |
| ------------------------ | ------------------------------------------- |
| `GaussianNoiseGenerator` | Adds gaussian noise to a generated dataset. |

#### Knowledge Graph Generator

For each knowledge graph representation there is a corresponding knowledge graph generator class.

### Configuration

All the code regarding configuration is located in `data_provider/synthetic_data_generation/config` and `data_provider/knowledge_graphs/config/knowledge_graph_generator_config.py`.
The configuration of the synthetic data generator can be split into two parts:

- Basic configuration like process parameters or quality features
- Module-specific configurations (one configuration for each module)

The complete configuration of a synthetic data generator is bundled into the `SdgConfig` class which is located in `data_provider/synthetic_data_generation/config/sdg_config.py`.

#### Basic configuration

##### Process Parameters

Each process parameter can be configured with the following attributes:
| Attribute | Type |Default| Description |
| ----------- | ------- |-| ------------------------------------- |
| `name` | `str` |required| Name of the process parameter |
| `min_value` | `float` |`0.0`| Minimal value the parameter can have. |
| `max_value` | `float` |`255.0`| Maximal value the parameter can have. |

##### Quality Features

Each quality feature can be configured with the following attributes:
| Attribute | Type |Default| Description |
| ----------- | ------- | -|------------------------------------- |
| `name` | `str` |required| Name of the process parameter |
| `min_rating` | `int` |`0`| Minimal rating the quality can have. |
| `max_rating` | `int` |`10`| Maximal rating the quality can have. |

#### Module configuration

##### PQ-Tuple Generator

###### BasicPQTupleGenerator

The `BasicPQTupleGenerator` can be configured with the following attributes:
| Attribute | Type |Default| Description |
| ----------- | ------- |-| ------------------------------------- |
| `expert_knowledge_share` | `float` |`0.75`| Proportion of the correlating pq-tuples that should be known information (expert knowledge). |
| `num_parameters` | `int` |Use all parameters| Number of process parameters that should be used to generate pq-tuples. |
| `num_qualities` | `int` |Use all qualities| Number of quality features that should be used to generate pq-tuples. |
|`min_qualities_per_parameter`|`int`|`1`|Minimum number of quality features a process parameter can influence.|
|`max_qualities_per_parameter`|`int | None`|`None`|Maximum number of quality features a process parameter can influence. If `None` there will be no maximum limit.|
|`pq_correlation_share`|`float`|`0.1`|Proportion of the pq-tuples that should correlate to each other.|
|`seed`|`int`|`42`|Seed used for the random number generator.|

##### PQ-Function

All pq-functions can only be configured by the `coeffs` attribute. If provided it must be a `tuple` of `int` with the same length as the coefficients of the function. If it's `None` the coefficients will be generated such that the pq-function covers nearly the whole process parameter and quality feature definition range.

##### PQ-Function Generator

###### SingleComplexityPQFunctionGenerator

The `SingleComplexityPQFunctionGenerator` can be configured with the following attributes:
| Attribute | Type |Default| Description |
| ----------- | ------- |-| ------------------------------------- |
|`pq_function`| `PQFunctionConfig | None`|Linear complexity|The pq-function used to modell the parameter-quality-correlations.|.
|`seed`|`int`|`42`| Seed used for the random number generator.|

##### Experiment Series Generator

###### Shared Attributes

All experiment series generators can be configured with the following attributes:
| Attribute | Type |Default| Description |
| ----------- | ------- |-| ------------------------------------- |
|`initial_quality_rating`|`str`|`worst`|Determines how the optimized quality ratings are initalized: <ul><li>`worst`: Initialize them with a nearly worst rating </li><li>`random`: Initalize them with random ratings</li></ul>|
|`num_qualities_to_optimize_per_series`|`int`|`1`|Number of quality features that are getting optimized per experiment series|
|`only_optimize_qualities_with_overlapping_parameters`|`bool`|`False`|If `True` only quality features with at least one overlapping influencing process parameter are getting optimized in an parametrization process. If `False` the optimized quality features are chosen randomly.|
|`quality_calculation_method`|`str`|`mean`|Determines how the quality rating is calculated from multiple process parameters<ul><li>`mean`: Calculate the mean of all quality ratings </li><li>`median`: Calculate the median of all quality ratings</li><li>`best`: Calculate the maximum of all quality ratings</li><li>`worst`: Calculate the minimum of all quality ratings</li></ul>|
|`score_threshold`|`float`|`0.05`|Threshold that determines when to stop the parameter opimization. The Score is in range [0;1] where 0 is the best and 1 the worst possible score.|
|`seed`|`int`|`42`| Seed used for the random number generator.|

###### ExpertKnowledgeExperimentSeriesGenerator

The `ExpertKnowledgeExperimentSeriesGenerator` can be configured with the following attributes:
| Attribute | Type |Default| Description |
| ----------- | ------- |-| ------------------------------------- |
|`max_series_size`|`int`|`15`|Maximum number of iterations a parametrization process can have.|

###### TrialExperimentSeriesGenerator

The `TrialExperimentSeriesGenerator` can be configured with the following attributes:
| Attribute | Type |Default| Description |
| ----------- | ------- |-| ------------------------------------- |
|`max_trial_length`|`int`|`25`|Number of iterations after the trial is stopped. If a positive influencing process parameter was found the max length can be exceeded.|
|`only_explore_one_improving_direction`|`bool`|`True`|If `True` the process parameter exploration will stop if an improving direction was found. If `False` the process paramater will be explored in the other direction as well.|
|`parameter_adjustment_method`|`str`|`definition_range`|Determines how a process parameter value gets adjusted in the parametrization process:<ul><li>`definition_range`: Adjust the process parameter by a percentage of the parmeter's definintion range</li><li>`current_value`: Adjust the process parameter by a percentage of the parmeter's current value. This method needs longer to converge.</li><li>`definition_range_then_current_value`: Adjust the process parameter by a percentage of the parmeter's definintion range until the parameter value would exceed the definition range; then adjust it by a percentage of the parmeter's current value.</li></ul>|
|`parameter_adjustment`|`float`|`0.1`|Adjustment value used by `parameter_adjustment_method`|

##### Experiment Generator

###### Shared Attributes

All experiment generators can be configured with the following attributes:
| Attribute | Type |Default| Description |
| ----------- | ------- |-| ------------------------------------- |
|`dataset_size`|`int`|`500`|Number of process iterations the dataset should contain.|
|`oversize_handling`|`str`|`ignore`|Determines how dataset oversize is handled:<ul><li>`ignore`: Ignore the oversize. The dataset will have a bigger size than specified.</li><li>`cut_first`: Cut the first iterations from all parametrization processes until the specified size is reached.</li><li>`cut_last`:Cut the last iterations from all parametrization processes until the specified size is reached.</li><li>`cut_random`: Cut random iterations from all parametrization processes until the specified size is reached.</li></ul>|
|`use_all_experiment_series`|`bool`|`True`|Determines if all generated parametrization processes are used. If `True` all parametrization processes are used for the final dataset. If `False` the parametrization processes are used until the dataset size limit is reached.|
|`seed`|`int`|`42`| Seed used for the random number generator.|

###### SingleTypeExperimentGenerator

The `SingleTypeExperimentGenerator` can be configured with the following attributes:
| Attribute | Type |Default| Description |
| ----------- | ------- |-| ------------------------------------- |
|`experiment_series`|`ExperimentSeriesGeneratorConfig | None`|`None`|The experiment series generator used to generate the parametrization processes. If `None` the `ExpertKnowledgeExperimentSeriesGenerator` with default values is used.|

###### MultiTypeExperimentGenerator

The `MultiTypeExperimentGenerator` can be configured with the following attributes:
| Attribute | Type |Default| Description |
| ----------- | ------- |-| ------------------------------------- |
|`experiment_series`|`Dict[float, ExperimentSeriesGeneratorConfig] | None`|`None`|Mapping between the used experiment series generators and the proportion of the dataset the generated parametrization processes should cover. If `None` the `ExpertKnowledgeExperimentSeriesGenerator` with default values is used for the whole dataset.|

##### Noise Generator

###### GaussianNoiseGenerator

The `GaussianNoiseGenerator` can be configured with the following attributes:
| Attribute | Type |Default| Description |
| ----------- | ------- |-| ------------------------------------- |
|`mean`|`float`|`0.0`|Mean of the gaussian (normal) distribution.|
|`standard_deviation_proportion`|`float`|`0.01`|Proportion of the parameter / quality interval length that is used as standard deviation of the gaussian (normal) distribution.|
|`noise_proportion`|`float`|`1.0`|Proportion of the process iterations that get noised.|
|`seed`|`int`|`42`| Seed used for the random number generator.|

##### Knowledge Graph Generator

###### Shared Attributes

All knowledge graph generators can be configured with the following attributes:
| Attribute | Type |Default| Description |
| ----------- | ------- |-| ------------------------------------- |
|`knowledge_share`|`float`|`1.0`|Proportion of the expert knowledge that is included into the knowledge graph.|
|`seed`|`int`|`42`| Seed used for the random number generator.|

The knowledge graph generators can be split into two different kind of configurations. They are defined as follow.

###### Type 1 Knowledge Graph Generator

Included in this type knowledge graph are the follwing representations:

- unquantified
- basic
- quantified parameters without shortcut
- quantified parameters with shortcut
- quantified parameters with literals
- quantified parameters w3
- quantified parameters w3 with literals

They can be configured with the following attributes:
| Attribute | Type |Default| Description |
| ----------- | ------- |-| ------------------------------------- |
|`edge_weight`|`str`|`mean_absolute`|Method used to calculate the process parameter quantification<ul><li>`mean_absolute`: Mean of all absolute changes of the process parameter </li></ul>|

###### Type 2 Knowledge Graph Generator

Included in this type knowledge graph are the follwing representations:

- quantified conditions without shortcut
- quantified conditions with shortcut
- quantified conditions with literals
- quantified conditions w3
- quantified conditions w3 with literals

They can be configured with the following attributes:
| Attribute | Type |Default| Description |
| ----------- | ------- |-| ------------------------------------- |
|`number_of_bins`|`int`|`5`| TODO|

### Process Data

The generated process data is represented by the class `GeneratedDataset`. Each dataset contains various parametrization process which are represented by the class `GeneratedExperimentSeries`. Each parametrization process consists of various process iterations which are represented by the class `GeneratedExperiment`.
All these classes are located in `data_provider/synthetic_data_generation/types/experiments.py`

#### GeneratedDataset

##### Properties

| Property            | Type                              | Description                                           |
| ------------------- | --------------------------------- | ----------------------------------------------------- |
| `experiment_series` | `List[GeneratedExperimentSeries]` | List of all parametrization processes in the dataset  |
| `pq_functions`      | `GeneratedPQFunctions`            | PQ-Functions that where used to generate this dataset |
| `pq_tuples`         | `GeneratedPQTuples`               | PQ-Tuples that where used to generate this dataset    |
| `sdg_config`        | [`SdgConfig`](#configuration)     | Configuration that was used to generate this dataset  |
| `all_experiments`   | `List[GeneratedExperiment]`       | List of all process iterations in the dataset         |

##### Methods (Selection)

| `def to_pandas_dataframe(self) -> pd.DataFrame`                                                                     |
| ------------------------------------------------------------------------------------------------------------------- |
| Converts the dataset to a pandas [`DataFrame`](https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.html). |
| Returns [`pd.DataFrame`](https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.html): Dataset as dataframe  |

| `def to_csv(self, path: str          | None) -> str                                                                                             | None` |
| -------- |
| Converts the dataset to csv format.  |
| Parameters: <br> <ul> <li>`path (str | None)`: Path where the csv file gets saved to. If None the csv string will be returned instead</li></ul> |
| Returns `str                         | None`: Csv string if path is `None`, else `None`                                                         |

| `def get_all_experiment_series_for_quality(self, quality: str) -> List[GeneratedExperimentSeries]`                           |
| ---------------------------------------------------------------------------------------------------------------------------- |
| Returns a list of all parametrization processes that optimize a specific quality feature.                                    |
| Parameters: <br> <ul> <li>`quality (str)`: Quality feature that should get optimized</li></ul>                               |
| Returns `List[GeneratedExperimentSeries]`: List of all parametrization processes that optimize the specified quality feature |

#### GeneratedExperimentSeries

##### Properties

| Property               | Type                        | Description                                                                     |
| ---------------------- | --------------------------- | ------------------------------------------------------------------------------- |
| `experiment_series_id` | `int`                       | Unique id of the parametrization process                                        |
| `experiments`          | `List[GeneratedExperiment]` | List of all process iterations in the parametrization process                   |
| `generation_approach`  | `str`                       | Generator used to generate this parametrization process                         |
| `optimized_qualities`  | `List[str]`                 | List of all quality features that get optimized in this parametrization process |

#### GeneratedExperiment

##### Properties

| Property        | Type              | Description                                                                                 |
| --------------- | ----------------- | ------------------------------------------------------------------------------------------- |
| `experiment_id` | `int`             | Unique id of the process iteration                                                          |
| `parameters`    | `Dict[str,float]` | Dictionary containing the values of all process parameters used in this process iteration   |
| `qualities`     | `Dict[str,float]` | Dictionary containing the values of all quality features this process iteration resulted in |

### Knowledge Graph

The module [`igraph`](https://igraph.readthedocs.io/en/0.10.2/index.html) is used to represent the generated knowledge graphs. It provides a wide variety of graph operations and analysis tools.

Knowledge graphs can also be converted to rdf format by using the `get_knowledge_graph_as_rdf` method in the synthetic data generator.

## Link Prediction Bias Analysis

The `notebooks/bias_analysis.ipynb` jupyter notebook provides a simple introduction into the usage of the link prediction bias analysis.

The `utils/link_prediction_bias_analysis.py` file where the bias analysis code is located can be also executed as module in order to generate a synthetic dataset and run the bias analysis for it. It generates an excel file containing information about the bias results:
`python -m utils.link_prediction_bias_analysis` <br>
The follwing command line arguments are available:
|Argument|Type|Description|
|-|-|-|
|`--sdg-config <path>`|`str`|Path to the sdg config file that is used to generate the dataset <br>Default: `configs/default_config_sdg.json`|
|`--use-literals`<br>`--no-use-literals`||Wheter to add the literals to the data (or not)<br>Default: `--no-use-literals`|
|`--test-split <x>`|`float`|Proportion of the data that is included in the test split <br> Default: `0.2`|
|`--seed <seed>`|`Any`|Random seed for the train-test-split <br>Default: `1111`|
|`--type1-threshold <t>`|`float`|Threshold for the type 1 bias <br>Default: `0.75`|
|`--type2-threshold <t>`|`float`|Threshold for the type 2 bias <br>Default: `0.5`|
|`--type3-threshold <t>`|`float`|Threshold for the type 3 bias <br>Default: `0.5`|
|`--output-dir <path>`|`str`|Path to where the output file gets saved to <br> Default: `outputs`|
|`--all-representations` <br> `--no-all-representations`||Wheter all knowledge graph representations should be analyized (or only the one defined in the sdg config) <br> Default: `--no-all-representations`|

By default the following command is executed if no command line arguments are passed:
`python -m utils.link_prediction_bias_analysis --sdg-config configs/default_config_sdg.json --no-use-literals --test-split 0.2 --seed 1111 --type1-threshold 0.75 --type2-threshold 0.5 --type13-threshold 0.5 --output-dir outputs --no-all-representations`

## TODO

- `number_of_bins` Beschreibung hinzufügen (bin da leider nicht so drin)
- Notebook + link pred bias analysis main testen
- Readme nochmal genau durchlesen und ggf. anpassen
